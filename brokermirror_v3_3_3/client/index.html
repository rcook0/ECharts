<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BrokerMirror</title><link rel="stylesheet" href="assets/styles.css"/>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script></head><body>
<header><div>BrokerMirror — v3.3.3</div>
<div class="right">
  <a class="badge" href="profile.html">Profile</a>
  <a class="badge" href="health.html">Health</a>
  <a class="badge" href="admin.html">Admin</a>
  <a class="badge" href="forensic.html">Forensic</a>
  <input id="jwt" placeholder="Bearer token" style="min-width:260px"><button id="setTok">Auth</button>
</div></header>
<main class="grid">
  <section class="panel">
    <div class="small">SignalMatrix — click a row to focus chart</div>
    <div class="flex" style="display:flex;gap:8px;align-items:center;margin:6px 0">
      <label>Endpoint</label><input id="ep" value="/api" style="width:120px">
      <label>TF</label><select id="tf"><option>M15</option><option>M5</option><option>H1</option></select>
      <button id="refresh">Refresh</button>
    </div>
    <div id="matrix"></div>
    <div class="flex" style="margin-top:10px;align-items:center;gap:8px">
      <label>Risk</label>
      <select id="riskPreset"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select>
      <button id="savePreset">Apply</button>
      <span id="presetMsg" class="small"></span>
    </div>
  </section>
  <section class="panel">
    <div class="flex" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label>Symbol</label><select id="sym"><option>EURUSD</option><option>BTCUSD</option><option>XAUUSD</option></select>
      <label>TF</label><select id="tf2"><option>M15</option><option>M5</option><option>H1</option></select>
      <label><input type="checkbox" id="showRsi"> RSI</label>
      <button id="load">Load</button>
      <button id="stream">Stream</button>
    </div>
    <div id="chart" style="margin-top:8px"></div>
    <div id="rsiChart" style="margin-top:8px;display:none"></div>
    <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
    <div class="flex" style="display:flex;gap:8px;align-items:center">
      <b>Paper Order</b>
      <label>Side</label><select id="side"><option>BUY</option><option>SELL</option></select>
      <label>Qty</label><input id="qty" type="number" min="0" step="1" value="1">
      <button id="place">Place Market</button>
      <span id="ordMsg" class="small"></span>
    </div>
  </section>
</main>
<script>
(document.getElementById("setTok")||{}).onclick=()=>{localStorage.setItem("jwt",document.getElementById("jwt").value.trim());alert("Token set");};
const hdr=()=>{const t=(localStorage.getItem("jwt")||"").trim();return t?{"Authorization":"Bearer "+t}:{}};const $=s=>document.querySelector(s);
document.getElementById("ep").value=localStorage.getItem("endpoint")||"/api";
const matrix=echarts.init(document.getElementById("matrix"));
const mainChart=echarts.init(document.getElementById("chart"));
const rsiChart=echarts.init(document.getElementById("rsiChart"));

function heatmapOption(xCats,yCats,data){
  return {
    tooltip:{formatter:(p)=>{const v=p.data[2]; const map={1:"Bullish",0:"Neutral",-1:"Bearish"};return `${yCats[p.data[1]]} • ${xCats[p.data[0]]}: <b>${map[v]}</b>`}},
    grid:{left:40,right:10,top:20,bottom:30},
    xAxis:{type:"category",data:xCats,axisLabel:{color:"#aaa"}},
    yAxis:{type:"category",data:yCats,axisLabel:{color:"#aaa"}},
    visualMap:{min:-1,max:1, calculable:false, orient:"horizontal", left:"center", bottom:0, pieces:[
      {value:1, label:"Bull", color:"#27d07f"}, {value:0, label:"Neutral", color:"#8a8f98"}, {value:-1, label:"Bear", color:"#ff6161"}
    ]},
    series:[{type:"heatmap",data, label:{show:false}, emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0,0,0,0.3)"} }}]
  };
}
async function loadMatrix(){
  const ep=$("#ep").value; localStorage.setItem("endpoint",ep);
  const tf=$("#tf").value;
  const syms=(await (await fetch(ep+"/symbols")).json()).symbols||["EURUSD","BTCUSD","XAUUSD"];
  const url=`${ep}/signals/matrix?tf=${tf}&symbols=${encodeURIComponent(syms.join(","))}`;
  const js=await (await fetch(url)).json();
  matrix.setOption(heatmapOption(js.x, js.y, js.data));
  matrix.off("click");
  matrix.on("click",(p)=>{
    const sym=js.y[p.data[1]];
    document.getElementById("sym").value=sym;
    document.getElementById("tf2").value=tf;
    render();
  });
}
async function render(){
  const ep=$("#ep").value; const sym=$("#sym").value; const tf=$("#tf2").value;
  const ind=await (await fetch(`${ep}/indicators?symbol=${sym}&tf=${tf}&limit=200`)).json();
  const t=ind.t.map(ts=>new Date(ts).toISOString().slice(11,16));
  const ohlc=(await (await fetch(`${ep}/products/forex/chart?symbol=${sym}&tf=${tf}&limit=200`)).json()).candles;
  const ohlcSeries=ohlc.map(b=>[b.o,b.c,b.l,b.h]);
  const series=[{type:"candlestick",data:ohlcSeries},{type:"line",data:ind.ind.ema_fast,showSymbol:false,smooth:true},{type:"line",data:ind.ind.ema_slow,showSymbol:false,smooth:true}];
  mainChart.setOption({xAxis:{type:"category",data:t},yAxis:{scale:true},series});
  if($("#showRsi").checked){document.getElementById("rsiChart").style.display="block"; rsiChart.setOption({xAxis:{type:"category",data:t},yAxis:{min:0,max:100},series:[{type:"line",data:ind.ind.rsi,showSymbol:false}]});}
  else{document.getElementById("rsiChart").style.display="none";}
}
document.getElementById("refresh").onclick=loadMatrix;
document.getElementById("load").onclick=render;
document.getElementById("showRsi").onchange=render;

document.getElementById("savePreset").onclick=async()=>{
  const ep=$("#ep").value; const preset=$("#riskPreset").value;
  const tok=(await (await fetch(`${ep}/auth/login?email=admin@local&password=admin123`,{method:"POST"})).json()).token;
  const res=await fetch(`${ep}/config/risk/preset`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+tok},body:JSON.stringify({preset})});
  const js=await res.json(); document.getElementById("presetMsg").textContent=res.ok?`Applied ${preset}`:(js.detail||"error");
};

document.getElementById("stream").onclick=()=>{ const s=io("/",{path:"/socket.io/"}); s.on("connect",()=>s.emit("subscribe",{symbol:document.getElementById("sym").value})); s.on("tick",()=>render()); };
document.getElementById("place").onclick=async()=>{ const ep=$("#ep").value; const payload={side:$("#side").value,symbol:$("#sym").value,qty:parseFloat($("#qty").value||"0")}; const res=await fetch(`${ep}/paper/order`,{method:"POST",headers:Object.assign({"Content-Type":"application/json"},hdr()),body:JSON.stringify(payload)}); const js=await res.json(); document.getElementById("ordMsg").textContent=res.ok?"OK":(js.detail||"error"); };
loadMatrix(); render();
</script></body></html>
